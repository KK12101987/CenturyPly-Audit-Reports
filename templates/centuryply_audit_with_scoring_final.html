<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CenturyPly - QA Scorecard & Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Neutrals & Muted Blue -->
    <!-- Application Structure Plan: The application utilizes a multi-tab structure: "Audit Scorecard," "Dashboard," "Raw Data," and "Manage Data." This design effectively segregates core functionalities: data entry for audits, comprehensive data analysis via interactive charts (dashboard), detailed review and deletion of records (raw data), and administrative management of master lists (RM, Team, Captain). This modular tabbed navigation promotes an organized and intuitive user experience, allowing users to efficiently switch between auditing, reporting, and data management tasks without clutter. A new "View Audit" modal provides a read-only detailed inspection of past records. A simulated "Admin Mode" toggle controls the editability of the audit scorecard, enhancing security for data entry. -->
    <!-- Visualization & Content Choices: The application visualizes audit data using the 7 QC Tools of Six Sigma, implemented with Chart.js, and leverages localStorage for data persistence. 1) Check Sheet: The "Audit Scorecard" form itself is the primary data collection tool. 2) Stratification: Achieved via interactive filters (Team, RM, Week) on the dashboard, allowing dynamic segmentation of all charts for targeted analysis. 3) Pareto Chart: A combo bar/line chart identifies the most frequent audit failures (parameters with low scores or uncollected data), enabling prioritization of coaching efforts. 4) Control Chart: A line chart tracks overall audit scores over time against statistical control limits to monitor process stability and identify outliers. 5) Histogram: A bar chart displays the frequency distribution of overall scores, offering insights into general performance trends. 6) Scatter Diagram: Shows the correlation between Basic Call Audit scores and Profile Completeness scores, revealing relationships in performance areas. 7) Fishbone Diagram: A static HTML/CSS diagram provides a visual framework for structured root cause analysis discussions. Key text content includes dynamic score summaries and automated final verdicts based on performance thresholds. Crucially, no SVG graphics or Mermaid JS are used, adhering strictly to the technical constraints while delivering a highly interactive and informative experience. LLM-powered features: "Summarize Feedback" on the audit form condenses qualitative notes. "Generate Coaching Tips" on the dashboard analyzes audit performance to suggest personalized development areas, now specifically for a selected RM if filtered. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-button.active { border-color: #3b82f6; color: #3b82f6; background-color: #eff6ff; }
        .chart-container { position: relative; width: 100%; max-width: 800px; margin-left: auto; margin-right: auto; height: 350px; max-height: 400px; }
        @media (min-width: 768px) { .chart-container { height: 400px; } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .fishbone{display:flex;align-items:center;margin:2rem auto}
        .fishbone .spine{flex-grow:1;height:3px;background-color:#475569}
        .fishbone .head{width:40px;height:40px;background-color:#475569;clip-path:polygon(0 50%,100% 0,100% 100%);display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:0.8rem;flex-shrink:0}
        .fishbone-body{display:flex;flex-direction:column;flex-grow:1;gap:4rem}
        .bone{display:flex;align-items:center;gap:1rem}
        .bone.top{flex-direction:row-reverse}
        .bone .bone-line{width:100px;height:2px;background-color:#94a3b8}
        .bone.top .bone-line{transform:rotate(-45deg) translate(30px, -30px);}
        .bone.bottom .bone-line{transform:rotate(45deg) translate(30px, 30px);}
        .bone .causes{font-size:0.9rem;color:#334155}
        .bone .category{font-weight:bold;font-size:1rem;color:#1e293b}
        /* Admin Mode Toggle Styling */
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #2196F3;
        }
        input:focus + .slider {
            box-shadow: 0 0 1px #2196F3;
        }
        input:checked + .slider:before {
            -webkit-transform: translateX(20px);
            -ms-transform: translateX(20px);
            transform: translateX(20px);
        }

        /* Print Specific Styles */
        @media print {
            body > *:not(.print-container) {
                display: none;
            }
            .print-container {
                display: block !important;
                width: 100%;
                margin: 0;
                padding: 1rem;
                font-family: 'Inter', sans-serif;
                color: #1e293b;
            }
            .print-container h1, .print-container h2, .print-container h3, .print-container h4 {
                color: #1e293b !important;
            }
            .print-container .grid {
                display: grid;
            }
            .print-container .space-y-4 > div {
                margin-bottom: 0.5rem;
            }
            .print-container fieldset {
                border: 1px solid #e2e8f0;
                padding: 1rem;
                margin-bottom: 1rem;
                border-radius: 0.5rem;
            }
            .print-container legend {
                font-weight: 600;
                color: #475569;
                padding: 0 0.5rem;
            }
            .print-container .text-sm {
                font-size: 0.875rem;
            }
            .print-container .font-medium {
                font-weight: 500;
            }
            .print-container .text-slate-600 {
                color: #475569;
            }
            .print-container .text-slate-800 {
                color: #1e293b;
            }
            .print-container .text-blue-600 {
                color: #2563eb;
            }

            /* Print specific page breaking and margins */
            .print-audit-record {
                page-break-after: always;
            }
            .print-audit-record:last-of-type { 
                page-break-after: auto; 
            }
            .print-coaching-tips {
                page-break-before: always;
                margin-top: 20mm; 
            }
            @page {
                size: A4;
                margin: 15mm; 
            }
            p, div { line-height: 1.3; margin-bottom: 0.3em; }
            fieldset { margin-bottom: 0.8rem; padding: 0.8rem; }
            h3 { margin-bottom: 0.8rem; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="mb-8 text-center">
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-900">CenturyPly QA Scorecard</h1>
            <p class="mt-2 text-lg text-slate-600">Interactive Audit & Performance Dashboard</p>
        </header>

        <div id="toast" class="hidden fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300">
            Audit saved successfully!
        </div>
        <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl text-center">
                <p class="text-lg font-semibold mb-4">Are you sure you want to delete all audit data?</p>
                <p class="text-sm text-red-600 mb-6">This action cannot be undone.</p>
                <div class="flex justify-center space-x-4">
                    <button id="confirm-delete" class="px-5 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Delete All</button>
                    <button id="cancel-delete" class="px-5 py-2 bg-slate-300 text-slate-800 rounded-md hover:bg-slate-400">Cancel</button>
                </div>
            </div>
        </div>
        <!-- Coaching Tips Modal -->
        <div id="coaching-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 md:w-3/4 lg:w-1/2 max-h-[80vh] overflow-y-auto">
                <h3 class="text-xl font-semibold text-slate-800 mb-4">‚ú® Generated Coaching Tips</h3>
                <div id="coachingTipsContent" class="text-slate-700 space-y-3">
                    <p>Analyzing performance data...</p>
                </div>
                <div class="mt-6 text-right">
                    <button id="close-coaching-modal" class="px-5 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">Close</button>
                </div>
            </div>
        </div>

        <!-- Audit View Modal -->
        <div id="audit-view-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 md:w-3/4 lg:w-1/2 max-h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-semibold text-slate-800 mb-4">Audit Details (View Only)</h3>
                <div id="auditViewContent" class="space-y-6">
                    <!-- Audit Context -->
                    <fieldset class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                        <legend class="text-lg font-semibold text-slate-700 px-2">Audit Context</legend>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                            <div><span class="font-medium text-slate-600">RM Name:</span> <span id="viewRmName" class="text-slate-800"></span></div>
                            <div><span class="font-medium text-slate-600">Team Name:</span> <span id="viewTeamName" class="text-slate-800"></span></div>
                            <div><span class="font-medium text-slate-600">Captain:</span> <span id="viewCaptainName" class="text-slate-800"></span></div>
                            <div><span class="font-medium text-slate-600">Audit Date:</span> <span id="viewAuditDate" class="text-slate-800"></span></div>
                            <div><span class="font-medium text-slate-600">Week No.:</span> <span id="viewWeekNumber" class="text-slate-800"></span></div>
                            <div><span class="font-medium text-slate-600">AID Mobile:</span> <span id="viewAidMobile" class="text-slate-800"></span></div>
                        </div>
                    </fieldset>

                    <!-- Basic Call Audit -->
                    
<!-- Scoring Framework (replaces Basic Call Audit) -->
<div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
  <div style="margin-bottom:0.5rem;">
    <label for="qaStatus" class="block text-sm font-medium text-slate-700">QA Status (mark exceptions)</label>
    <select id="qaStatus" class="mt-1 block w-full sm:w-64 rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
      <option value="">-- Select Status --</option>
      <option value="No Calls">No Calls</option>
      <option value="No Auditable Call">No Auditable Call</option>
      <option value="Picnic">Picnic</option>
      <option value="HO">HO</option>
      <option value="Absent">Absent</option>
    </select>
    <div class="text-sm text-slate-500 mt-2">Selecting a non-auditable status will disable scoring inputs and save the status to the backend (CSV log).</div>
  </div>

  <details id="scoringFrameworkDetails" open class="mt-4">
    <summary style="font-size:1.125rem; font-weight:600; color:#b91c1c; cursor:pointer; margin-bottom:0.5rem;">Scoring Framework for Relationship Managers (QA Evaluation Protocol)</summary>
    <div class="mt-3 space-y-3 text-sm text-slate-700">

      <h4 style="font-weight:700; color:#1f2937;">Critical Fail Criteria</h4>
      <p>The following parameters are <strong>Critical Fail</strong>: <em>Redemption, GTM Adherence, CRM Update</em>.</p>
      <ol>
        <li>If the RM fails to explicitly perform, mention or demonstrate adherence to any of these three parameters during the audited call, the RM receives <strong>0 marks</strong> for that parameter.</li>
        <li>Any occurrence of a Critical Fail will set the <strong>overall total score for that audit to 0</strong> (audit invalidated) regardless of other parameter scores.</li>
        <li>The QA auditor must record the specific reason in the <em>Audit Observation</em> field.</li>
      </ol>

      <h4 style="font-weight:700; color:#1f2937;">Situation-Based Criterion ‚Äî Project Registration</h4>
      <p><strong>Project Registration</strong> is scored only if it was contextually expected during the call. Triggers for applicability include:</p>
      <ul>
        <li>Customer mentions an ongoing/upcoming project.</li>
        <li>RM discusses delivery, project site, or previous registration entries.</li>
        <li>CRM reminders or follow-ups indicate registration should occur.</li>
      </ul>
      <p>If the QA determines Project Registration was <em>not</em> relevant, mark it as <strong>N/A (Full Marks Awarded)</strong> to avoid penalizing the RM.</p>

      <h4 style="font-weight:700; color:#1f2937;">Summary Table</h4>
      <table style="width:100%; border-collapse:collapse; font-size:0.95rem;">
        <thead><tr style="background:#111827; color:#ffffff;"><th style="text-align:left; padding:6px;">Parameter</th><th style="text-align:right; padding:6px;">Max Marks</th></tr></thead>
        <tbody>
          <tr><td style="padding:6px;">Introduction</td><td style="padding:6px; text-align:right;">5</td></tr>
          <tr><td style="padding:6px;">Project Registration (Situation-based)</td><td style="padding:6px; text-align:right;">10</td></tr>
          <tr><td style="padding:6px;">Product & Pricing requirement</td><td style="padding:6px; text-align:right;">10</td></tr>
          <tr><td style="padding:6px;">Product Feedback</td><td style="padding:6px; text-align:right;">10</td></tr>
          <tr><td style="padding:6px;">Cross & Upsell of product</td><td style="padding:6px; text-align:right;">10</td></tr>
          <tr><td style="padding:6px;">Marketing Benefit</td><td style="padding:6px; text-align:right;">10</td></tr>
          <tr><td style="padding:6px;">Redemption <em style='color:#b91c1c'>(Critical)</em></td><td style="padding:6px; text-align:right;">10</td></tr>
          <tr><td style="padding:6px;">Call Closure</td><td style="padding:6px; text-align:right;">5</td></tr>
          <tr><td style="padding:6px;">GTM Adherence <em style='color:#b91c1c'>(Critical)</em></td><td style="padding:6px; text-align:right;">10</td></tr>
          <tr><td style="padding:6px;">CRM Update <em style='color:#b91c1c'>(Critical)</em></td><td style="padding:6px; text-align:right;">10</td></tr>
          <tr><td style="padding:6px;">Softskill</td><td style="padding:6px; text-align:right;">10</td></tr>
          <tr style="font-weight:700; background:#111827; color:#fff;"><td style="padding:6px;">Total Score</td><td style="padding:6px; text-align:right;">100</td></tr>
        </tbody>
      </table>

      <h4 style="font-weight:700; color:#1f2937;">Implementation Notes</h4>
      <ul>
        <li>QA auditors MUST mark Critical Fail occurrences explicitly in the <em>Audit Observation</em> field.</li>
        <li>The frontend will auto-disable scoring inputs when a non-auditable QA Status is selected.</li>
        <li>QA Status selections are saved to the backend CSV at <code>reports/qa_status_log.csv</code> via POST to <code>/save_status</code>.</li>
      </ul>

    </div>
  </details>
</div>

<script>
// Front-end: handle QA Status selection and POST to backend CSV logger
document.addEventListener('DOMContentLoaded', function(){
  const qaSelect = document.getElementById('qaStatus');
  qaSelect.addEventListener('change', async function(){
    const status = qaSelect.value;
    const rmName = document.getElementById('rmName')?.value || 'Unknown RM';
    const evaluator = document.getElementById('captainName')?.value || 'QA_User';
    if(!status) {
      // Re-enable form if cleared
      document.querySelectorAll('#audit-form input, #audit-form select, #audit-form textarea, #audit-form button').forEach(el => { el.disabled = false; });
      return;
    }
    // Disable scoring inputs except the selector itself
    document.querySelectorAll('#audit-form input, #audit-form select, #audit-form textarea, #audit-form button').forEach(el => {
      if(el.id !== 'qaStatus') el.disabled = true;
    });

    try {
      const res = await fetch('/save_status', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ rm_name: rmName, evaluator: evaluator, status })
      });
      const j = await res.json();
      alert(j.message || 'QA Status saved.');
    } catch (e) {
      alert('Failed to save QA Status to backend. Please ensure the /save_status endpoint is available.');
    }
  });
});
</script>


                    <!-- Profile Completeness -->
                    <fieldset class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                        <legend class="text-lg font-semibold text-slate-700 px-2">AID Profile Completeness</legend>
                        <div id="viewProfileParams" class="mt-2 space-y-3"></div>
                    </fieldset>

                    <!-- Summary -->
                    <fieldset class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                        <legend class="text-lg font-semibold text-slate-700 px-2">Audit Summary</legend>
                        <div class="mt-2 space-y-2">
                            <div><span class="font-medium text-slate-600">Basic Score:</span> <span id="viewBasicScore" class="text-slate-800 font-bold"></span></div>
                            <div><span class="font-medium text-slate-600">Profile Score:</span> <span id="viewProfileScore" class="text-slate-800 font-bold"></span></div>
                            <div><span class="font-medium text-slate-600">Overall Score:</span> <span id="viewTotalScore" class="text-blue-600 font-bold text-lg"></span></div>
                            <div><span class="font-medium text-slate-600">Automated Verdict:</span> <span id="viewAutomatedVerdict" class="text-slate-800"></span></div>
                            <div><span class="font-medium text-slate-600">Additional Feedback:</span> <span id="viewAdditionalVerdict" class="text-slate-800"></span></div>
                        </div>
                    </fieldset>
                </div>
                <div class="mt-6 text-right">
                    <button id="close-audit-view-modal" class="px-5 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">Close</button>
                </div>
            </div>
        </div>

        <!-- Validation Error Modal -->
        <div id="validation-modal" class="hidden fixed inset-0 bg-red-600 bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-1/3">
                <h3 class="text-xl font-semibold text-red-700 mb-4">üö® Incomplete Sections</h3>
                <ul id="validationErrorsList" class="list-disc list-inside text-red-600 space-y-1">
                    <!-- Errors will be listed here -->
                </ul>
                <div class="mt-6 text-right">
                    <button id="close-validation-modal" class="px-5 py-2 bg-red-500 text-white rounded-md hover:bg-red-600">Got It</button>
                </div>
            </div>
        </div>

        <nav class="mb-8 border-b border-slate-200">
            <div class="flex justify-center space-x-2 sm:space-x-4" id="nav-buttons">
                <button data-tab="scorecard" class="tab-button active text-sm sm:text-base font-medium py-3 px-4 sm:px-6 border-b-2 border-transparent hover:border-slate-300 hover:bg-slate-100 transition">Audit Scorecard</button>
                <button data-tab="dashboard" class="tab-button text-sm sm:text-base font-medium py-3 px-4 sm:px-6 border-b-2 border-transparent hover:border-slate-300 hover:bg-slate-100 transition">Dashboard</button>
                <button data-tab="data" class="tab-button text-sm sm:text-base font-medium py-3 px-4 sm:px-6 border-b-2 border-transparent hover:border-slate-300 hover:bg-slate-100 transition">Raw Data</button>
                <button data-tab="manage" class="tab-button text-sm sm:text-base font-medium py-3 px-4 sm:px-6 border-b-2 border-transparent hover:border-slate-300 hover:bg-slate-100 transition">Manage Data</button>
            </div>
        </nav>

        <main>
            <!-- Scorecard Tab -->
            <div id="scorecard-tab" class="space-y-8">
                <form id="audit-form" class="space-y-8">
                    <!-- Section 1: Audit Context -->
                    <fieldset class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                        <legend class="text-xl font-semibold text-slate-800 px-2">Audit Context</legend>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-4">
                            <div><label for="rmName" class="block text-sm font-medium text-slate-700">Relationship Manager</label><input type="text" id="rmName" required class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" list="rmList"></div>
                            <datalist id="rmList"></datalist>
                            <div><label for="teamName" class="block text-sm font-medium text-slate-700">Team Name</label><input type="text" id="teamName" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" list="teamList"></div>
                            <datalist id="teamList"></datalist>
                            <div><label for="captainName" class="block text-sm font-medium text-slate-700">RM's Captain</label><input type="text" id="captainName" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" list="captainList"></div>
                            <datalist id="captainList"></datalist>
                            <div><label for="auditDate" class="block text-sm font-medium text-slate-700">Date of Audit</label><input type="date" id="auditDate" required class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                            <div><label for="weekNumber" class="block text-sm font-medium text-slate-700">Week Number (of Month)</label><input type="number" id="weekNumber" required min="1" max="5" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" readonly></div>
                            <div><label for="aidMobile" class="block text-sm font-medium text-slate-700">AID Mobile Number</label><input type="text" id="aidMobile" required class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                        </div>
                    </fieldset>

                    <!-- Section 2 & 3: Parameters -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 space-y-8">
                            <!-- Basic Call Audit -->
                            <fieldset class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                                <legend class="text-xl font-semibold text-slate-800 px-2">Basic Call Audit</legend>
                                <div id="basic-audit-params" class="mt-4 space-y-4"></div>
                            </fieldset>

                             <!-- Profile Completeness -->
                            <fieldset class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                                <legend class="text-xl font-semibold text-slate-800 px-2">AID Profile Completeness</legend>
                                <div id="profile-params" class="mt-4 space-y-4"></div>
                            </fieldset>
                        </div>
                        
                        <!-- Scoring Summary -->
                        <div class="lg:col-span-1">
                            <div class="sticky top-8 bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                                <h3 class="text-xl font-semibold text-slate-800">Audit Score</h3>
                                <div class="mt-4 space-y-3">
                                    <div class="flex justify-between items-baseline"><span>Basic Call Audit:</span><span id="basicScore" class="font-bold text-lg">0 / 80</span></div>
                                    <div class="flex justify-between items-baseline"><span>Profile Completeness:</span><span id="profileScore" class="font-bold text-lg">0 / 20</span></div>
                                    <hr class="my-2">
                                    <div class="flex justify-between items-baseline text-2xl font-bold text-blue-600"><span>Total Score:</span><span id="totalScore">0 / 100</span></div>
                                </div>
                                <div class="mt-6">
                                    <label for="finalVerdictDisplay" class="block text-sm font-medium text-slate-700 mb-1">Automated Final Verdict</label>
                                    <p id="finalVerdictDisplay" class="font-semibold text-lg text-slate-900 mb-4"></p>
                                    <label for="additionalVerdict" class="block text-sm font-medium text-slate-700 mb-1">Additional Feedback</label>
                                    <div class="flex items-center gap-2">
                                        <textarea id="additionalVerdict" rows="5" placeholder="Add any additional comments here..." class="block flex-1 rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></textarea>
                                        <button type="button" id="summarizeFeedbackBtn" class="p-2 bg-blue-100 text-blue-800 rounded-md hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 text-sm font-medium">‚ú® Summarize</button>
                                    </div>
                                    <div id="summarizeLoading" class="hidden text-sm text-slate-500 mt-2">Generating summary...</div>
                                </div>
                                <div class="mt-6 flex space-x-4">
                                    <button type="submit" id="save-audit" class="flex-1 inline-flex justify-center items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Save Audit</button>
                                    <button type="button" id="reset-form" class="flex-1 inline-flex justify-center items-center px-6 py-3 border border-slate-300 text-base font-medium rounded-md shadow-sm text-slate-700 bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500">Reset</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboard-tab" class="hidden space-y-8">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                    <h3 class="text-xl font-semibold text-slate-800 mb-4">Dashboard Filters</h3>
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="filterTeam" class="block text-sm font-medium text-slate-700">Filter by Team</label>
                            <select id="filterTeam" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"></select>
                        </div>
                        <div>
                            <label for="filterRM" class="block text-sm font-medium text-slate-700">Filter by RM</label>
                            <select id="filterRM" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"></select>
                        </div>
                        <div>
                            <label for="filterWeek" class="block text-sm font-medium text-slate-700">Filter by Week (of month)</label>
                            <select id="filterWeek" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"></select>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                        <h3 class="text-lg font-semibold text-slate-800 mb-1">Pareto Chart of Audit Failures</h3>
                        <p class="text-sm text-slate-500 mb-4">Identifies the most frequent reasons for low scores to prioritize improvements.</p>
                        <div class="chart-container"><canvas id="paretoChart"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                        <h3 class="text-lg font-semibold text-slate-800 mb-1">Overall Score Distribution (Histogram)</h3>
                        <p class="text-sm text-slate-500 mb-4">Shows the frequency of scores across different ranges.</p>
                        <div class="chart-container"><canvas id="histogramChart"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 lg:col-span-2">
                        <h3 class="text-lg font-semibold text-slate-800 mb-1">Score Trend (Control Chart)</h3>
                        <p class="text-sm text-slate-500 mb-4">Tracks the average audit score over time against control limits to monitor process stability.</p>
                        <div class="chart-container"><canvas id="controlChart"></canvas></div>
                    </div>
                     <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                        <h3 class="text-lg font-semibold text-slate-800 mb-1">Basic Audit vs. Profile Score (Scatter)</h3>
                         <p class="text-sm text-slate-500 mb-4">Explores the relationship between call quality and profile data completeness.</p>
                        <div class="chart-container"><canvas id="scatterChart"></canvas></div>
                    </div>
                     <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 flex flex-col">
                        <h3 class="text-lg font-semibold text-slate-800 mb-1">Cause & Effect (Fishbone) Diagram</h3>
                        <p class="text-sm text-slate-500 mb-4">A framework for brainstorming the root causes of quality issues during team meetings. <span class="font-semibold text-blue-700">This diagram is for conceptual brainstorming and is not data-driven in this application.</span></p>
                        <div class="fishbone flex-grow">
                            <div class="fishbone-body">
                                <div class="flex justify-around">
                                    <div class="bone top"><div class="causes">Method<br>Process</div><div class="bone-line"></div><div class="category">Process</div></div>
                                    <div class="bone top"><div class="causes">Training<br>Skills</div><div class="bone-line"></div><div class="category">People</div></div>
                                    <div class="bone top"><div class="causes">Software<br>Hardware</div><div class="bone-line"></div><div class="category">Tools</div></div>
                                </div>
                                <div class="spine"></div>
                                <div class="flex justify-around">
                                    <div class="bone bottom"><div class="category">Policy</div><div class="bone-line"></div><div class="causes">Guidelines<br>Rules</div></div>
                                    <div class="bone bottom"><div class="category">Environment</div><div class="bone-line"></div><div class="causes">Workplace<br>Distractions</div></div>
                                    <div class="bone bottom"><div class="category">Measurement</div><div class="bone-line"></div><div class="causes">Metrics<br>Audit Criteria</div></div>
                                </div>
                            </div>
                            <div class="head">Effect</div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 mt-8">
                            <h3 class="text-xl font-semibold text-slate-800 mb-4">üí° Brainstormed Causes for Issues</h3>
                            <button id="generateFishboneCausesBtn" class="px-4 py-2 bg-indigo-500 text-white rounded-md shadow-sm hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Generate Cause Ideas</button>
                            <div id="fishboneCausesLoading" class="hidden text-sm text-slate-500 mt-2">Generating ideas...</div>
                            <div id="fishboneCausesDisplay" class="text-slate-700 space-y-2 mt-4">
                                <p>Click "Generate Cause Ideas" to get suggestions for brainstorming root causes.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Coaching Tips Section -->
                <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-slate-800">‚ú® Performance Coaching Tips</h3>
                        <button id="generateCoachingTipsBtn" class="px-4 py-2 bg-purple-500 text-white rounded-md shadow-sm hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">Generate Coaching Tips</button>
                    </div>
                    <div id="coachingTipsLoading" class="hidden text-sm text-slate-500 mb-4">Generating tips...</div>
                    <div id="coachingTipsDisplay" class="text-slate-700 space-y-2">
                        <p>Click "Generate Coaching Tips" to get personalized suggestions based on the filtered data.</p>
                    </div>
                </div>
                <!-- Print Scorecard Section -->
                <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-slate-800">üñ®Ô∏è Print Scorecard</h3>
                        <button id="printScorecardBtn" class="px-4 py-2 bg-green-500 text-white rounded-md shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">Print Scorecard</button>
                    </div>
                    <p class="text-sm text-slate-600">Print the current dashboard view, including generated coaching tips, for records or team discussions.</p>
                </div>
            </div>

            <!-- Raw Data Tab -->
            <div id="data-tab" class="hidden">
                 <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-slate-800">Audit Data Records</h3>
                        <div class="flex items-center space-x-4">
                            <span class="text-sm font-medium text-slate-700">Admin Mode (Enable Editing):</span>
                            <label class="switch">
                                <input type="checkbox" id="adminModeToggle">
                                <span class="slider"></span>
                            </label>
                            <button id="deleteAllData" class="px-4 py-2 bg-red-500 text-white rounded-md shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">Delete All Data</button>
                        </div>
                    </div>
                    <input type="text" id="dataSearch" placeholder="Search records..." class="mb-4 block w-full max-w-xs rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-200">
                            <thead class="bg-slate-50">
                                <tr id="dataTableHead"></tr>
                            </thead>
                            <tbody id="dataTableBody" class="bg-white divide-y divide-slate-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Manage Data Tab -->
            <div id="manage-tab" class="hidden space-y-8">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                    <h3 class="text-xl font-semibold text-slate-800 mb-6">Manage RM, Team & Captain Data</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div>
                            <h4 class="text-lg font-semibold text-slate-700 mb-3">Manage Relationship Managers</h4>
                            <div class="flex flex-col gap-2 mb-4">
                                <input type="text" id="newRmName" placeholder="RM Name" class="rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                <input type="text" id="newRmTeam" placeholder="Team Name (auto-add if new)" class="rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" list="teamListDatalistMgmt">
                                <datalist id="teamListDatalistMgmt"></datalist>
                                <input type="text" id="newRmCaptain" placeholder="Captain Name (auto-add if new)" class="rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" list="captainListDatalistMgmt">
                                <datalist id="captainListDatalistMgmt"></datalist>
                                <button id="addRm" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">Add RM</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-slate-200">
                                    <thead class="bg-slate-50">
                                        <tr>
                                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">RM Name</th>
                                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Team</th>
                                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Captain</th>
                                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="rmListDisplay" class="bg-white divide-y divide-slate-200">
                                        <!-- RM rows will be rendered here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div>
                            <h4 class="text-lg font-semibold text-slate-700 mb-3">Manage Teams</h4>
                            <div class="flex mb-4">
                                <input type="text" id="newTeamName" placeholder="Add new Team" class="flex-1 rounded-l-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                <button id="addTeam" class="px-4 py-2 bg-blue-500 text-white rounded-r-md hover:bg-blue-600">Add</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-slate-200">
                                    <thead class="bg-slate-50">
                                        <tr>
                                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Team Name</th>
                                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="teamListDisplay" class="bg-white divide-y divide-slate-200">
                                        <!-- Team rows will be rendered here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div>
                            <h4 class="text-lg font-semibold text-slate-700 mb-3">Manage Captains</h4>
                            <div class="flex mb-4">
                                <input type="text" id="newCaptainName" placeholder="Add new Captain" class="flex-1 rounded-l-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                <button id="addCaptain" class="px-4 py-2 bg-blue-500 text-white rounded-r-md hover:bg-blue-600">Add</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-slate-200">
                                    <thead class="bg-slate-50">
                                        <tr>
                                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Captain Name</th>
                                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="captainListDisplay" class="bg-white divide-y divide-slate-200">
                                        <!-- Captain rows will be rendered here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    const AUDIT_DATA_STORAGE_KEY = 'centuryPlyAuditData';
    const MASTER_DATA_STORAGE_KEY = 'centuryPlyMasterData';

    // Global variable to track which audit is currently being edited
    let editingAuditId = null; 

    const auditParams = {
        basic: [
            { category: 'Call Opening', weight: 10, items: [
                { id: 'greeting', label: 'Professional Greeting', weight: 5 },
                { id: 'verification', label: 'AID Verification', weight: 5 }
            ]},
            { category: 'Communication & Soft Skills', weight: 20, items: [
                { id: 'clarity', label: 'Clarity of Speech', weight: 5 },
                { id: 'listening', label: 'Active Listening & Empathy', weight: 5 },
                { id: 'tone', label: 'Professional Tone & Language', weight: 5 },
                { id: 'objections', label: 'Handling Objections/Queries', weight: 5 }
            ]},
            { category: 'Product Knowledge & Information', weight: 20, items: [
                { id: 'accuracy', label: 'Accurate Product Information', weight: 10 },
                { id: 'explanation', label: 'Clear Explanation of Features/Benefits', weight: 10 }
            ]},
            { category: 'Process, CRM & Ticketing', weight: 20, items: [
                { id: 'meetingInfo', label: 'Meeting Info Section Updated', type: 'checkbox', weight: 5 },
                { id: 'projectTicket', label: 'New Project Ticket Raised (if applicable)', type: 'discussion-checkbox', weight: 5 },
                { id: 'serviceTicket', label: 'Service Ticket Raised (if applicable)', type: 'discussion-checkbox', weight: 5 },
                { id: 'privacy', label: 'Data Privacy Compliance', type: 'checkbox', weight: 5 }
            ]},
            { category: 'Call Closing', weight: 10, items: [
                { id: 'nextSteps', label: 'Clear Next Steps Provided', weight: 5 },
                { id: 'closing', label: 'Professional Closing', weight: 5 }
            ]}
        ],
        profile: [
            { id: 'aidName', label: 'Name of the AID', weight: 2 },
            { id: 'officeAddress', label: 'Office Address', weight: 2 },
            { id: 'pan', label: 'PAN Card Number', weight: 2 },
            { id: 'gstin', label: 'GSTIN', weight: 2 },
            { id: 'projectType', label: 'Type of Project', weight: 2 },
            { id: 'numPliesUsed', label: 'Number of Plies Used', weight: 2 },
            { id: 'projectRangeMoney', label: 'Min Project Range (Money)', weight: 2 },
            { id: 'projectRangeArea', label: 'Min Project Range (Area)', weight: 2 }, 
            { id: 'secondaryContactName', label: 'Secondary Contact Name', weight: 2 },
            { id: 'secondaryContactMobile', label: 'Secondary Contact Mobile', weight: 2 },
            { id: 'secondaryContactPosition', label: 'Secondary Contact Position', weight: 2 },
            
        ]
    };
    
    let auditData = [];
    // Master data now stores RMs as objects to link them to teams/captains
    let masterData = { rms: [], teams: [], captains: [], weeks: [] }; 

    const basicParamsContainer = document.getElementById('basic-audit-params');
    const profileParamsContainer = document.getElementById('profile-params');
    const finalVerdictDisplay = document.getElementById('finalVerdictDisplay');
    const additionalVerdict = document.getElementById('additionalVerdict');
    const summarizeFeedbackBtn = document.getElementById('summarizeFeedbackBtn');
    const summarizeLoading = document.getElementById('summarizeLoading');
    const confirmModal = document.getElementById('confirm-modal');
    const confirmDeleteBtn = document.getElementById('confirm-delete');
    const cancelDeleteBtn = document.getElementById('cancel-delete'); // Corrected ID for consistency
    const auditDateInput = document.getElementById('auditDate');
    const weekNumberInput = document.getElementById('weekNumber');

    // Dashboard coaching & print elements
    const generateCoachingTipsBtn = document.getElementById('generateCoachingTipsBtn');
    const coachingTipsLoading = document.getElementById('coachingTipsLoading');
    const coachingTipsDisplay = document.getElementById('coachingTipsDisplay');
    const coachingModal = document.getElementById('coaching-modal');
    const closeCoachingModalBtn = document.getElementById('close-coaching-modal');
    const printScorecardBtn = document.getElementById('printScorecardBtn'); 

    // Fishbone LLM elements
    const generateFishboneCausesBtn = document.getElementById('generateFishboneCausesBtn');
    const fishboneCausesLoading = document.getElementById('fishboneCausesLoading');
    const fishboneCausesDisplay = document.getElementById('fishboneCausesDisplay');

    // Audit View Modal elements
    const auditViewModal = document.getElementById('audit-view-modal');
    const auditViewContent = document.getElementById('auditViewContent');
    const closeAuditViewModalBtn = document.getElementById('close-audit-view-modal');

    // Validation Modal elements
    const validationModal = document.getElementById('validation-modal');
    const validationErrorsList = document.getElementById('validationErrorsList');
    const closeValidationModalBtn = document.getElementById('close-validation-modal');

    // Master data management elements
    const rmNameInput = document.getElementById('rmName');
    const teamNameInput = document.getElementById('teamName');
    const captainNameInput = document.getElementById('captainName');

    const rmListDatalist = document.getElementById('rmList');
    const teamListDatalist = document.getElementById('teamList');
    const captainListDatalist = document.getElementById('captainList');
    
    const teamListDatalistMgmt = document.getElementById('teamListDatalistMgmt');
    const captainListDatalistMgmt = document.getElementById('captainListDatalistMgmt');

    const newRmNameInput = document.getElementById('newRmName');
    const newRmTeamInput = document.getElementById('newRmTeam');
    const newRmCaptainInput = document.getElementById('newRmCaptain');
    const addRmButton = document.getElementById('addRm');
    const rmListDisplay = document.getElementById('rmListDisplay'); 

    const newTeamNameInput = document.getElementById('newTeamName');
    const addTeamButton = document.getElementById('addTeam');
    const teamListDisplay = document.getElementById('teamListDisplay'); 

    const newCaptainNameInput = document.getElementById('newCaptainName');
    const addCaptainButton = document.getElementById('addCaptain');
    const captainListDisplay = document.getElementById('captainListDisplay'); 

    // Admin Mode toggle and associated form elements
    const adminModeToggle = document.getElementById('adminModeToggle');
    const auditForm = document.getElementById('audit-form');
    const saveAuditBtn = document.getElementById('save-audit');
    const resetFormBtn = document.getElementById('reset-form');


    // --- Data Persistence (localStorage) ---
    const loadAuditData = () => {
        try {
            const storedData = localStorage.getItem(AUDIT_DATA_STORAGE_KEY);
            if (storedData) {
                auditData = JSON.parse(storedData);
            }
        } catch (e) {
            console.error("Failed to load audit data from localStorage:", e);
            auditData = [];
        }
    };

    const saveAuditData = () => {
        try {
            localStorage.setItem(AUDIT_DATA_STORAGE_KEY, JSON.stringify(auditData));
        } catch (e) {
            console.error("Failed to save audit data to localStorage:", e);
        }
    };

    const loadMasterData = () => {
        try {
            const storedData = localStorage.getItem(MASTER_DATA_STORAGE_KEY);
            if (storedData) {
                const parsedData = JSON.parse(storedData);
                masterData.rms = Array.isArray(parsedData.rms) ? parsedData.rms : [];
                masterData.teams = Array.isArray(parsedData.teams) ? parsedData.teams : [];
                masterData.captains = Array.isArray(parsedData.captains) ? parsedData.captains : [];
                masterData.weeks = Array.isArray(parsedData.weeks) ? parsedData.weeks : [];
            }
        } catch (e) {
            console.error("Failed to load master data from localStorage:", e);
            masterData = { rms: [], teams: [], captains: [], weeks: [] };
        }
    };

    const saveMasterData = () => {
        try {
            localStorage.setItem(MASTER_DATA_STORAGE_KEY, JSON.stringify(masterData));
        }
        catch (e) {
            console.error("Failed to save master data to localStorage:", e);
        }
    };

    const clearAllAuditData = () => {
        auditData = [];
        localStorage.removeItem(AUDIT_DATA_STORAGE_KEY);
        resetForm();
        updateDashboard();
        renderDataTable();
        confirmModal.classList.add('hidden');
    };

    // --- Admin Mode Logic ---
    // Function to enable/disable all input elements on the audit form
    const setFormElementsEnabled = (enable) => {
        const formElements = auditForm.querySelectorAll('input, select, textarea, button[type="submit"], button[type="button"]:not(#summarizeFeedbackBtn):not(#reset-form)');
        formElements.forEach(el => {
            // Week number is always read-only/disabled
            if (el.id === 'weekNumber') {
                el.disabled = true;
                el.readOnly = true;
            } else {
                el.disabled = !enable;
                el.readOnly = !enable;
            }
            // Re-enable/disable checkbox within discussion-checkbox based on its own value and form enable state
            if (el.id && el.id.startsWith('discussion-')) {
                const associatedCheckbox = document.getElementById(el.id.replace('discussion-', ''));
                if (associatedCheckbox) {
                    if (el.value === 'Not Discussed') {
                        associatedCheckbox.disabled = true; // Always disabled if "Not Discussed"
                    } else {
                        associatedCheckbox.disabled = !enable; // Otherwise, depends on form enable state
                    }
                }
            }
        });
        // Save and Reset buttons are always active on Scorecard tab
        saveAuditBtn.disabled = false;
        resetFormBtn.disabled = false;
        summarizeFeedbackBtn.disabled = false; // Summarize feedback is always available for a new audit
    };

    adminModeToggle.addEventListener('change', () => {
        renderDataTable(); // Re-render data table to show/hide edit buttons
        // Admin mode toggle does NOT affect initial audit scorecard for new entries.
        // It only affects editing existing records in the Raw Data tab.
    });

    // --- Form Generation ---
    const createDropdown = (id, weight) => {
        const select = document.createElement('select');
        select.id = id;
        select.className = 'block w-24 rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm';
        for (let i = 0; i <= weight; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = i;
            select.appendChild(option);
        }
        select.value = 0;
        return select;
    };

    const createCheckbox = (id) => {
        const input = document.createElement('input');
        input.type = 'checkbox';
        input.id = id;
        input.className = 'h-5 w-5 rounded border-slate-300 text-blue-600 focus:ring-blue-500';
        return input;
    };
    
    const createProfileDropdown = (id) => {
        const select = document.createElement('select');
        select.id = id;
        select.className = 'block w-28 rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm';
        ['N/A', 'No', 'Yes'].forEach(val => {
            const option = document.createElement('option');
            option.value = val;
            option.textContent = val;
            select.appendChild(option);
        });
        return select;
    };

    const createDiscussionCheckbox = (id, label) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'flex items-center gap-2';
        
        const select = document.createElement('select');
        select.id = `discussion-${id}`;
        select.className = 'block w-36 rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm';
        ['Discussed', 'Not Discussed'].forEach(val => {
            const option = document.createElement('option');
            option.value = val;
            option.textContent = val;
            select.appendChild(option);
        });
        select.value = 'Discussed'; // Default to discussed
        wrapper.appendChild(select);

        const checkbox = createCheckbox(id);
        const checkboxLabel = document.createElement('label');
        checkboxLabel.htmlFor = id;
        checkboxLabel.textContent = ' Achieved';
        wrapper.appendChild(checkbox);
        wrapper.appendChild(checkboxLabel);

        select.addEventListener('change', () => {
            if (select.value === 'Not Discussed') {
                checkbox.checked = true; // Automatically award points
                checkbox.disabled = true; // Disable interaction
            } else {
                checkbox.disabled = false; // Enable interaction
                checkbox.checked = false; // Reset to unchecked when discussed (QA will check manually)
            }
            calculateScores();
        });

        return wrapper;
    };

    auditParams.basic.forEach(cat => {
        const categoryWrapper = document.createElement('div');
        const categoryHeader = document.createElement('h4');
        categoryHeader.className = 'text-md font-semibold text-slate-700 mt-6 mb-2 border-b pb-1';
        categoryHeader.textContent = cat.category;
        categoryWrapper.appendChild(categoryHeader);

        cat.items.forEach(param => {
            const div = document.createElement('div');
            div.className = 'grid grid-cols-1 md:grid-cols-[1fr,auto,1fr] gap-4 items-center';
            div.innerHTML = `<label for="${param.id}" class="text-sm text-slate-600">${param.label}</label>`;
            
            const controlWrapper = document.createElement('div');
            if (param.type === 'checkbox') {
                controlWrapper.appendChild(createCheckbox(param.id));
            } else if (param.type === 'discussion-checkbox') {
                controlWrapper.appendChild(createDiscussionCheckbox(param.id, param.label));
            } else {
                controlWrapper.appendChild(createDropdown(param.id, param.weight));
            }
            div.appendChild(controlWrapper);
            // Add generate feedback button
            div.innerHTML += `
                <div class="flex items-center gap-2">
                    <textarea id="feedback-${param.id}" rows="1" placeholder="Optional feedback..." class="text-sm w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    <button type="button" data-param-id="${param.id}" class="generate-feedback-btn p-1 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-300 text-xs font-medium">‚ú®</button>
                </div>
                <div id="feedbackLoading-${param.id}" class="hidden text-xs text-slate-500 mt-1">Generating...</div>
            `;
            categoryWrapper.appendChild(div);
        });
        basicParamsContainer.appendChild(categoryWrapper);
    });
    
    auditParams.profile.forEach(param => {
        const div = document.createElement('div');
        div.className = 'grid grid-cols-1 md:grid-cols-[1fr,auto,1fr] gap-4 items-center';
        div.innerHTML = `<label for="${param.id}" class="text-sm text-slate-600">${param.label}</label>`;
        const controlWrapper = document.createElement('div');
        controlWrapper.appendChild(createProfileDropdown(param.id));
        div.appendChild(controlWrapper);
        div.innerHTML += `<input type="text" id="data-${param.id}" placeholder="Enter data if available..." class="text-sm w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">`;
        profileParamsContainer.appendChild(div);
    });

    // --- Auto-calculate Week Number ---
    const calculateWeekNumber = () => {
        const dateStr = auditDateInput.value;
        if (!dateStr) {
            weekNumberInput.value = '';
            return;
        }
        const date = new Date(dateStr + 'T00:00:00'); // Use T00:00:00 to avoid timezone issues
        const dayOfMonth = date.getDate();
        const firstDayOfMonth = new Date(date.getFullYear(), date.getMonth(), 1);
        const firstDayOfMonthWeekday = firstDayOfMonth.getDay(); // 0 for Sunday, 1 for Monday...

        // Adjust for week starting on Monday (common in business context)
        // If Sunday is 0, make it 7 so Monday is 1.
        const adjustedFirstDay = (firstDayOfMonthWeekday === 0) ? 7 : firstDayOfMonthWeekday;

        const weekNumber = Math.ceil((dayOfMonth + adjustedFirstDay - 1) / 7);
        weekNumberInput.value = weekNumber;
    };
    auditDateInput.addEventListener('change', calculateWeekNumber);

    // --- Scoring Logic & Automated Verdict ---
    const getFinalVerdict = (score) => {
        if (score >= 90) return 'Excellent Performance - Demonstrates high quality!';
        if (score >= 80) return 'Good Performance - Meets expectations.';
        if (score >= 60) return 'Needs Improvement - Requires attention in some areas.';
        return 'Critical Improvement Needed - Immediate coaching recommended.';
    };

    // Original calculateScores function
    const _calculateScores = () => {
        let currentBasicScore = 0;
        auditParams.basic.forEach(cat => {
            cat.items.forEach(param => {
                const el = document.getElementById(param.id);
                const discussionEl = document.getElementById(`discussion-${param.id}`);

                if (el) {
                    if (param.type === 'checkbox') {
                        if (el.checked) currentBasicScore += param.weight;
                    } else if (param.type === 'discussion-checkbox') {
                         if (discussionEl && discussionEl.value === 'Not Discussed') {
                            currentBasicScore += param.weight; // Award full points if not discussed
                        } else if (el.checked) {
                            currentBasicScore += param.weight; // Award points if discussed and checked
                        }
                    } else {
                        currentBasicScore += parseInt(el.value, 10);
                    }
                }
            });
        });

        let currentProfileScore = 0;
        auditParams.profile.forEach(param => {
            const el = document.getElementById(param.id);
            if (el && el.value === 'Yes') {
                currentProfileScore += param.weight;
            }
        });

        const totalOverallScore = currentBasicScore + currentProfileScore;

        document.getElementById('basicScore').textContent = `${currentBasicScore} / 80`;
        document.getElementById('profileScore').textContent = `${currentProfileScore} / 20`;
        document.getElementById('totalScore').textContent = `${totalOverallScore} / 100`;
        finalVerdictDisplay.textContent = getFinalVerdict(totalOverallScore);
    };


    // --- Form Completion Validation ---
    const isFormCompletelyScored = (highlight = false) => {
        let isValid = true;
        const errors = [];

        // Clear previous highlights and errors
        document.querySelectorAll('.border-red-500').forEach(el => el.classList.remove('border-red-500'));
        if (highlight) validationErrorsList.innerHTML = ''; // Clear for modal display

        // Context Fields
        const contextFields = ['rmName', 'teamName', 'captainName', 'auditDate', 'aidMobile'];
        contextFields.forEach(id => {
            const el = document.getElementById(id);
            if (!el.value.trim()) {
                isValid = false;
                errors.push(`${el.previousElementSibling.textContent.replace(':', '')} is required.`);
                if (highlight) el.classList.add('border-red-500');
            }
        });

        // Basic Call Audit Parameters
        auditParams.basic.forEach(cat => {
            cat.items.forEach(param => {
                const el = document.getElementById(param.id);
                const feedbackEl = document.getElementById(`feedback-${param.id}`);
                
                // Ensure feedback is given for each parameter
                if (!feedbackEl.value.trim()) {
                     isValid = false;
                     errors.push(`Feedback for "${param.label}" is required.`);
                     if (highlight) feedbackEl.classList.add('border-red-500');
                }

                if (param.type === 'checkbox') {
                    // Checkboxes are considered "scored" if they exist, but if we need to force selection
                    // For now, only feedback is required for completion.
                } else if (param.type === 'discussion-checkbox') {
                    const discussionEl = document.getElementById(`discussion-${param.id}`);
                    // If "Discussed", the checkbox needs to be explicitly checked. If "Not Discussed", it's auto-checked.
                    if (discussionEl && discussionEl.value === 'Discussed' && !el.checked) {
                        isValid = false;
                        errors.push(`"${param.label}" (Achieved) must be checked if 'Discussed'.`);
                        if (highlight) el.classList.add('border-red-500');
                    }
                } else { // Regular dropdown scores
                    if (parseInt(el.value, 10) === 0 && param.weight > 0) { 
                        isValid = false;
                        errors.push(`"${param.label}" needs a score (cannot be 0 if relevant).`); // User must select a score.
                        if (highlight) el.classList.add('border-red-500');
                    }
                }
            });
        });

        // AID Profile Completeness Parameters
        auditParams.profile.forEach(param => {
            const el = document.getElementById(param.id);
            if (el.value === 'N/A') {
                isValid = false;
                errors.push(`"${param.label}" status must be 'Yes' or 'No'.`);
                if (highlight) el.classList.add('border-red-500');
            }
        });

        // Additional Feedback is checked here
        if (!additionalVerdict.value.trim()) {
            isValid = false;
            errors.push('Additional Feedback is required.');
            if (highlight) additionalVerdict.classList.add('border-red-500');
        }

        if (!isValid && highlight) {
            errors.forEach(error => {
                const li = document.createElement('li');
                li.textContent = error;
                validationErrorsList.appendChild(li);
            });
            validationModal.classList.remove('hidden');
        }

        return isValid;
    };

    // New calculateScores function that incorporates validation and button activation
    const calculateScores = () => {
        _calculateScores(); // Run the base score calculation
        const saveAuditBtn = document.getElementById('save-audit');
        if (isFormCompletelyScored(false)) { // Don't highlight during live calculation
            saveAuditBtn.disabled = false;
            // automated verdict is already set by _calculateScores
        } else {
            saveAuditBtn.disabled = true;
            finalVerdictDisplay.textContent = 'Audit in Progress...';
        }
    };
    
    document.getElementById('audit-form').addEventListener('input', calculateScores); 

    // --- Form Submission & Reset ---
    const resetForm = () => {
        document.getElementById('audit-form').reset();
        additionalVerdict.value = '';
        calculateScores(); // Recalculate to set initial scores and verdict
        // Reset discussion checkboxes
        auditParams.basic.forEach(cat => {
            cat.items.forEach(param => {
                if (param.type === 'discussion-checkbox') {
                    const discussionEl = document.getElementById(`discussion-${param.id}`);
                    const checkboxEl = document.getElementById(param.id);
                    if (discussionEl) discussionEl.value = 'Discussed';
                    if (checkboxEl) {
                        checkboxEl.checked = false;
                        checkboxEl.disabled = false; // Re-enable for new entries
                    }
                }
            });
        });
        document.querySelectorAll('.border-red-500').forEach(el => el.classList.remove('border-red-500'));
        editingAuditId = null; // Clear editing state
        // Ensure form elements are enabled for new entries after reset
        setFormElementsEnabled(true); 
    };

    document.getElementById('reset-form').addEventListener('click', resetForm);
    
    document.getElementById('audit-form').addEventListener('submit', (e) => {
        e.preventDefault();
        
        // If editing an existing audit, check admin mode
        if (editingAuditId && !adminModeToggle.checked) {
            alert("Admin Mode is off. Please enable Admin Mode in the 'Raw Data' tab to save edited audits.");
            return;
        }

        // Validate the form before attempting to save
        if (!isFormCompletelyScored(true)) { // Pass true to highlight errors and show modal
            return; 
        }

        const currentAudit = {
            id: editingAuditId || Date.now(), 
            rmName: rmNameInput.value,
            teamName: teamNameInput.value,
            captainName: captainNameInput.value,
            auditDate: auditDateInput.value,
            weekNumber: weekNumberInput.value,
            aidMobile: document.getElementById('aidMobile').value,
            scores: {},
            additionalVerdict: additionalVerdict.value,
        };

        let basicScore = 0;
        auditParams.basic.forEach(cat => {
            cat.items.forEach(param => {
                const el = document.getElementById(param.id);
                const feedbackEl = document.getElementById(`feedback-${param.id}`);
                currentAudit.scores[`feedback-${param.id}`] = feedbackEl ? feedbackEl.value : '';

                if (param.type === 'discussion-checkbox') {
                    const discussionEl = document.getElementById(`discussion-${param.id}`);
                    currentAudit.scores[`discussion-${param.id}`] = discussionEl ? discussionEl.value : 'Discussed';

                    if (discussionEl && discussionEl.value === 'Not Discussed') {
                        currentAudit.scores[param.id] = true;
                        basicScore += param.weight;
                    } else if (el) {
                        currentAudit.scores[param.id] = el.checked;
                        if (el.checked) basicScore += param.weight;
                    }
                } else if (el) {
                    if (param.type === 'checkbox') {
                        currentAudit.scores[param.id] = el.checked;
                        if(el.checked) basicScore += param.weight;
                    } else {
                        const score = parseInt(el.value, 10);
                        currentAudit.scores[param.id] = score;
                        basicScore += score;
                    }
                }
            });
        });

        let profileScore = 0;
        auditParams.profile.forEach(param => {
            const el = document.getElementById(param.id);
            const dataEl = document.getElementById(`data-${param.id}`);
            currentAudit.scores[`data-${param.id}`] = dataEl ? dataEl.value : '';

            if (el) {
                currentAudit.scores[param.id] = el.value;
                if(el.value === 'Yes') profileScore += param.weight;
            }
        });

        currentAudit.totalBasicScore = basicScore;
        currentAudit.totalProfileScore = profileScore;
        currentAudit.overallScore = basicScore + profileScore;
        currentAudit.automatedVerdict = getFinalVerdict(currentAudit.overallScore);

        if (editingAuditId) {
            // Update existing audit
            const index = auditData.findIndex(a => a.id === editingAuditId);
            if (index !== -1) {
                auditData[index] = currentAudit;
            }
        } else {
            // Add new audit
            auditData.push(currentAudit);
        }
        saveAuditData();
        
        const toast = document.getElementById('toast');
        toast.classList.remove('hidden');
        setTimeout(() => toast.classList.add('hidden'), 3000);

        const wasEditingRecord = editingAuditId !== null; 
        resetForm(); // This resets editingAuditId to null and clears form fields
        updateDashboard();
        renderDataTable(); // Re-render table to reflect changes

        if (wasEditingRecord) {
            document.querySelector("button[data-tab='data']").click();
        }
    });

    // Function to populate the form for editing
    const populateFormForEdit = (audit) => {
        rmNameInput.value = audit.rmName;
        teamNameInput.value = audit.teamName;
        captainNameInput.value = audit.captainName;
        auditDateInput.value = audit.auditDate;
        weekNumberInput.value = audit.weekNumber;
        document.getElementById('aidMobile').value = audit.aidMobile;

        auditParams.basic.forEach(cat => {
            cat.items.forEach(param => {
                const el = document.getElementById(param.id);
                const feedbackEl = document.getElementById(`feedback-${param.id}`);
                if (el) {
                    if (param.type === 'checkbox') {
                        el.checked = audit.scores[param.id] || false;
                    } else if (param.type === 'discussion-checkbox') {
                        const discussionEl = document.getElementById(`discussion-${param.id}`);
                        if (discussionEl) {
                            discussionEl.value = audit.scores[`discussion-${param.id}`] || 'Discussed';
                            discussionEl.dispatchEvent(new Event('change')); // Trigger change to set checkbox disabled state correctly
                        }
                        el.checked = audit.scores[param.id] || false;
                    } else {
                        el.value = audit.scores[param.id] !== undefined ? audit.scores[param.id] : 0;
                    }
                }
                if (feedbackEl) feedbackEl.value = audit.scores[`feedback-${param.id}`] || '';
            });
        });

        auditParams.profile.forEach(param => {
            const el = document.getElementById(param.id);
            const dataEl = document.getElementById(`data-${param.id}`);
            if (el) el.value = audit.scores[param.id] || 'N/A';
            if (dataEl) dataEl.value = audit.scores[`data-${param.id}`] || '';
        });

        additionalVerdict.value = audit.additionalVerdict || '';
        calculateScores(); // Recalculate scores for the loaded data
        
        setFormElementsEnabled(true); // Explicitly enable all fields for editing a specific record
        editingAuditId = audit.id; // Set the ID of the audit being edited
        
        document.querySelector("button[data-tab='scorecard']").click(); // Switch to scorecard tab
    };

    // Auto-fill Team and Captain when RM name is selected/entered
    rmNameInput.addEventListener('change', (e) => {
        const selectedRmName = e.target.value;
        const selectedRm = masterData.rms.find(rm => rm.name === selectedRmName);
        if (selectedRm) {
            teamNameInput.value = selectedRm.team || '';
            captainNameInput.value = selectedRm.captain || '';
        } else {
            // If RM not found or input cleared, clear team/captain
            teamNameInput.value = '';
            captainNameInput.value = '';
        }
    });


    // --- Navigation ---
    const tabs = ['scorecard', 'dashboard', 'data', 'manage'];
    document.getElementById('nav-buttons').addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            const targetTab = e.target.dataset.tab;
            tabs.forEach(tab => {
                document.getElementById(`${tab}-tab`).classList.toggle('hidden', tab !== targetTab);
                document.querySelector(`button[data-tab='${tab}']`).classList.toggle('active', tab === targetTab);
            });
            if (targetTab === 'dashboard') {
                updateDashboard();
            } else if (targetTab === 'data') {
                renderDataTable();
            } else if (targetTab === 'manage') {
                renderMasterDataLists();
                populateDatalists();
            } else if (targetTab === 'scorecard') {
                // When navigating back to scorecard, reset form for a new entry
                // unless we are in an active editing session (editingAuditId is not null).
                if (editingAuditId === null) {
                    resetForm(); 
                } else {
                    // If we were editing, ensure form remains enabled
                    setFormElementsEnabled(true);
                }
            }
        }
    });

    // --- Dashboard ---
    let charts = {};
    const initCharts = () => {
        const chartConfigs = {
            paretoChart: { type: 'bar', data: {}, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: 'Failure Count' } }, y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false }, ticks: { callback: value => `${value}%`} } }, plugins: { tooltip: { callbacks: { label: function(context) { let label = context.dataset.label || ''; if (label) { label += ': '; } if (context.parsed.y !== null) { label += context.parsed.y.toFixed(2) + (context.dataset.yAxisID === 'y1' ? '%' : ''); } return label; } } } } } },
            histogramChart: { type: 'bar', data: {}, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: 'Number of Audits'} }, x: { title: { display: true, text: 'Score Range'} } } } },
            controlChart: { type: 'line', data: {}, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100, title: { display: true, text: 'Overall Score'} }, x: { type: 'category', title: { display: true, text: 'Audit Date'} } } } },
            scatterChart: { type: 'scatter', data: {}, options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'linear', position: 'bottom', title: {display: true, text: 'Basic Audit Score (out of 80)'}}, y: { title: {display: true, text: 'Profile Completeness Score (out of 20)'}} } } }
        };

        Object.keys(chartConfigs).forEach(id => {
            const ctx = document.getElementById(id).getContext('2d');
            if (charts[id]) {
                charts[id].destroy(); // Destroy existing chart instance before creating a new one
            }
            charts[id] = new Chart(ctx, chartConfigs[id]);
        });
    };
    
    const updateDashboard = () => {
        const team = document.getElementById('filterTeam').value;
        const rm = document.getElementById('filterRM').value;
        const week = document.getElementById('filterWeek').value;
        
        let filteredData = auditData;
        if (team !== 'all') filteredData = filteredData.filter(d => d.teamName === team);
        if (rm !== 'all') filteredData = filteredData.filter(d => d.rmName === rm);
        if (week !== 'all') filteredData = filteredData.filter(d => d.weekNumber == week);
        
        if (filteredData.length === 0) {
            Object.values(charts).forEach(chart => {
                chart.data = { labels: [], datasets: [] };
                chart.update();
            });
            coachingTipsDisplay.innerHTML = '<p>No data available to generate coaching tips for the current filters.</p>';
            fishboneCausesDisplay.innerHTML = '<p>No data available for cause brainstorming.</p>';
            return;
        }

        updateFilters();
        updateParetoChart(filteredData);
        updateHistogramChart(filteredData);
        updateControlChart(filteredData);
        updateScatterChart(filteredData);
    };
    
    const updateFilters = () => {
        // Collect all unique teams and RMs from auditData and masterData
        const allTeams = new Set([...auditData.map(d => d.teamName), ...masterData.teams].filter(Boolean));
        const allRms = new Set([...auditData.map(d => d.rmName), ...masterData.rms.map(rm => rm.name)].filter(Boolean));
        const allWeeks = new Set([...auditData.map(d => d.weekNumber).filter(Boolean)]);

        const teams = ['all', ...Array.from(allTeams).sort()];
        const rms = ['all', ...Array.from(allRms).sort()];
        const weeks = ['all', ...Array.from(allWeeks).sort((a,b) => a-b)];

        const populateSelect = (id, options) => {
            const select = document.getElementById(id);
            const currentValue = select.value;
            select.innerHTML = '';
            options.forEach(opt => {
                const optionElement = document.createElement('option');
                optionElement.value = opt;
                optionElement.textContent = opt === 'all' ? 'All' : opt;
                select.appendChild(optionElement);
            });
            select.value = currentValue && options.includes(currentValue) ? currentValue : 'all';
        };
        
        populateSelect('filterTeam', teams);
        populateSelect('filterRM', rms);
        populateSelect('filterWeek', weeks);
    };
    
    document.getElementById('filterTeam').addEventListener('change', updateDashboard);
    document.getElementById('filterRM').addEventListener('change', updateDashboard);
    document.getElementById('filterWeek').addEventListener('change', updateDashboard);

    const updateParetoChart = (data) => {
        const failures = {};
        const allParams = [...auditParams.basic.flatMap(c => c.items), ...auditParams.profile];

        data.forEach(audit => {
            allParams.forEach(p => {
                if (p.type === 'checkbox') {
                    if (audit.scores[p.id] === false) {
                        failures[p.label] = (failures[p.label] || 0) + 1;
                    }
                } else if (p.type === 'discussion-checkbox') {
                    const discussionStatus = audit.scores[`discussion-${p.id}`];
                    if (discussionStatus === 'Discussed' && audit.scores[p.id] === false) {
                        failures[p.label] = (failures[p.label] || 0) + 1;
                    }
                }
                else if (p.category) { // Basic audit score items
                    const score = audit.scores[p.id];
                    // Consider a "failure" if score is less than 60% of max weight
                    if (score !== undefined && score < (p.weight * 0.6)) { 
                         failures[p.label] = (failures[p.label] || 0) + 1;
                    }
                } else { // Profile completeness items
                    if (audit.scores[p.id] === 'No' || audit.scores[p.id] === 'N/A') {
                        failures[p.label] = (failures[p.label] || 0) + 1;
                    }
                }
            });
        });
        
        const sortedFailures = Object.entries(failures).sort(([,a],[,b]) => b-a);
        const labels = sortedFailures.map(([label]) => {
            if (label && label.length > 25) {
                return label.substring(0, 22) + '...';
            }
            return label;
        });
        const counts = sortedFailures.map(([,count]) => count);
        
        const totalFailures = counts.reduce((sum, val) => sum + val, 0);
        let cumulativePercentage = 0;
        const cumulativeData = counts.map(count => {
            cumulativePercentage += (count / totalFailures) * 100;
            return cumulativePercentage;
        });

        charts.paretoChart.data = {
            labels,
            datasets: [
                { label: 'Failure Count', data: counts, backgroundColor: 'rgba(59, 130, 246, 0.6)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 1, order: 2 },
                { label: 'Cumulative %', data: cumulativeData, type: 'line', yAxisID: 'y1', backgroundColor: 'rgba(239, 68, 68, 0.2)', borderColor: 'rgba(239, 68, 68, 1)', fill: false, order: 1, tension: 0.3 }
            ]
        };
        charts.paretoChart.update();
    };

    const updateHistogramChart = (data) => {
        const scoreBins = { '0-50':0, '51-60':0, '61-70':0, '71-80':0, '81-90':0, '91-100':0 };
        data.forEach(audit => {
            const score = audit.overallScore;
            if (score <= 50) scoreBins['0-50']++;
            else if (score <= 60) scoreBins['51-60']++;
            else if (score <= 70) scoreBins['61-70']++;
            else if (score <= 80) scoreBins['71-80']++;
            else if (score <= 90) scoreBins['81-90']++;
            else scoreBins['91-100']++;
        });

        charts.histogramChart.data = {
            labels: Object.keys(scoreBins),
            datasets: [{
                label: 'Number of Audits',
                data: Object.values(scoreBins),
                backgroundColor: 'rgba(22, 163, 74, 0.6)',
                borderColor: 'rgba(22, 163, 74, 1)',
                borderWidth: 1
            }]
        };
        charts.histogramChart.update();
    };
    
    const updateControlChart = (data) => {
        const sortedData = [...data].sort((a,b) => new Date(a.auditDate) - new Date(b.auditDate));
        const labels = sortedData.map(d => d.auditDate);
        const scores = sortedData.map(d => d.overallScore);
        
        if (scores.length === 0) {
            charts.controlChart.data = { labels: [], datasets: [] };
            charts.controlChart.update();
            return;
        }

        const avg = scores.reduce((sum, val) => sum + val, 0) / scores.length;
        const stdDev = scores.length > 1 ? Math.sqrt(scores.map(x => Math.pow(x - avg, 2)).reduce((a, b) => a + b) / (scores.length - 1)) : 0;
        const ucl = avg + 2 * stdDev;
        const lcl = avg - 2 * stdDev;

        charts.controlChart.data = {
            labels,
            datasets: [
                { label: 'Overall Score', data: scores, borderColor: 'rgba(59, 130, 246, 1)', tension: 0.1, fill: false, pointBackgroundColor: 'rgba(59, 130, 246, 1)', pointBorderColor: 'rgba(59, 130, 246, 1)' },
                { label: 'Average', data: Array(scores.length).fill(avg), borderColor: 'rgba(22, 163, 74, 1)', borderWidth: 2, pointRadius: 0, borderDash: [5, 5] },
                { label: 'UCL', data: Array(scores.length).fill(ucl), borderColor: 'rgba(239, 68, 68, 1)', borderWidth: 2, pointRadius: 0, borderDash: [5, 5] },
                { label: 'LCL', data: Array(scores.length).fill(lcl), borderColor: 'rgba(239, 68, 68, 1)', borderWidth: 2, pointRadius: 0, borderDash: [5, 5] }
            ]
        };
        charts.controlChart.update();
    };

    const updateScatterChart = (data) => {
        const scatterData = data.map(audit => ({
            x: audit.totalBasicScore,
            y: audit.totalProfileScore
        }));
        
        charts.scatterChart.data = {
            datasets: [{
                label: 'Audit Score Correlation',
                data: scatterData,
                backgroundColor: 'rgba(139, 92, 246, 0.6)'
            }]
        };
        charts.scatterChart.update();
    };

    // --- Raw Data Table ---
    const dataTableHead = document.getElementById('dataTableHead');
    const dataTableBody = document.getElementById('dataTableBody');
    const dataSearch = document.getElementById('dataSearch');

    const renderDataTable = () => {
        const headers = ['Date', 'RM Name', 'Team', 'Week', 'Overall Score', 'Automated Verdict', 'Additional Feedback', 'Actions'];
        dataTableHead.innerHTML = `<tr>${headers.map(h => `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">${h}</th>`).join('')}</tr>`;
        
        const searchTerm = dataSearch.value.toLowerCase();
        const filteredData = auditData.filter(d => 
            Object.values(d).some(val => String(val).toLowerCase().includes(searchTerm) || 
                                       (d.scores && Object.values(d.scores).some(sVal => String(sVal).toLowerCase().includes(searchTerm))))
        ).sort((a,b) => b.id - a.id); // Sort by newest first

        dataTableBody.innerHTML = '';
        if (filteredData.length === 0) {
            dataTableBody.innerHTML = `<tr><td colspan="${headers.length}" class="px-6 py-4 text-center text-sm text-slate-500">No audit records found.</td></tr>`;
            return;
        }

        filteredData.forEach(audit => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${audit.auditDate}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${audit.rmName}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${audit.teamName}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${audit.weekNumber}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-bold ${audit.overallScore > 85 ? 'text-green-600' : audit.overallScore > 60 ? 'text-yellow-600' : 'text-red-600'}">${audit.overallScore}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 max-w-xs truncate" title="${audit.automatedVerdict}">${audit.automatedVerdict}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 max-w-sm truncate" title="${audit.additionalVerdict}">${audit.additionalVerdict}</td>
                <td class="px-6 py-4 whitespace-nowrap text-left text-sm font-medium space-x-2">
                    <button class="view-audit-btn text-blue-600 hover:text-blue-900" data-audit-id="${audit.id}">View</button>
                    <button class="edit-audit-btn text-yellow-600 hover:text-yellow-900 ${adminModeToggle.checked ? '' : 'hidden'}" data-audit-id="${audit.id}">Edit</button>
                </td>
            `;
            dataTableBody.appendChild(row);
        });
    };

    dataTableBody.addEventListener('click', (e) => {
        if (e.target.classList.contains('view-audit-btn')) {
            const auditId = parseInt(e.target.dataset.auditId);
            showAuditDetailsModal(auditId);
        } else if (e.target.classList.contains('edit-audit-btn')) {
            const auditId = parseInt(e.target.dataset.auditId);
            const auditToEdit = auditData.find(a => a.id === auditId);
            if (auditToEdit) {
                populateFormForEdit(auditToEdit);
            }
            // Once editing, ensure the main form is enabled regardless of admin mode toggle
            // (admin mode only controls visibility of edit button, actual editing is always enabled for the loaded record)
            setFormElementsEnabled(true); 
        }
    });

    dataSearch.addEventListener('input', renderDataTable);

    // --- Delete All Data ---
    document.getElementById('deleteAllData').addEventListener('click', () => {
        confirmModal.classList.remove('hidden');
    });

    confirmDeleteBtn.addEventListener('click', clearAllAuditData);
    cancelDeleteBtn.addEventListener('click', () => {
        confirmModal.classList.add('hidden');
    });

    // --- Audit View Modal Functions ---
    const showAuditDetailsModal = (auditId) => {
        const audit = auditData.find(a => a.id === auditId);
        if (!audit) {
            alert('Audit record not found.');
            return;
        }

        // Populate header fields
        document.getElementById('viewRmName').textContent = audit.rmName;
        document.getElementById('viewTeamName').textContent = audit.teamName;
        document.getElementById('viewCaptainName').textContent = audit.captainName;
        document.getElementById('viewAuditDate').textContent = audit.auditDate;
        document.getElementById('viewWeekNumber').textContent = audit.weekNumber;
        document.getElementById('viewAidMobile').textContent = audit.aidMobile;

        // Populate basic audit parameters
        const viewBasicAuditParamsContainer = document.getElementById('viewBasicAuditParams');
        viewBasicAuditParamsContainer.innerHTML = '';
        auditParams.basic.forEach(cat => {
            const categoryHeader = document.createElement('h5');
            categoryHeader.className = 'text-md font-semibold text-slate-600 mt-4 border-b pb-1';
            categoryHeader.textContent = cat.category;
            viewBasicAuditParamsContainer.appendChild(categoryHeader);

            cat.items.forEach(param => {
                const div = document.createElement('div');
                div.className = 'grid grid-cols-1 md:grid-cols-2 gap-2 text-sm';
                const paramValue = audit.scores[param.id];
                const feedbackValue = audit.scores[`feedback-${param.id}`] || 'N/A';

                let displayValue;
                if (param.type === 'checkbox' || param.type === 'discussion-checkbox') {
                    displayValue = paramValue ? 'Achieved' : 'Not Achieved';
                    if (param.type === 'discussion-checkbox') {
                        const discussionStatus = audit.scores[`discussion-${param.id}`] || 'Discussed';
                        displayValue = `${discussionStatus} - ${displayValue}`;
                    }
                } else {
                    displayValue = `${paramValue} / ${param.weight}`;
                }
                
                div.innerHTML = `
                    <span class="font-medium text-slate-700">${param.label}:</span>
                    <span class="text-slate-800">${displayValue}</span>
                    <span class="font-medium text-slate-700">Feedback:</span>
                    <span class="text-slate-800">${feedbackValue}</span>
                `;
                viewBasicAuditParamsContainer.appendChild(div);
            });
        });

        // Populate profile completeness parameters
        const viewProfileParamsContainer = document.getElementById('viewProfileParams');
        viewProfileParamsContainer.innerHTML = '';
        auditParams.profile.forEach(param => {
            const div = document.createElement('div');
            div.className = 'grid grid-cols-1 md:grid-cols-2 gap-2 text-sm';
            const profileStatus = audit.scores[param.id] || 'N/A';
            const dataFieldValue = audit.scores[`data-${param.id}`] || 'N/A';
            
            div.innerHTML = `
                <span class="font-medium text-slate-700">${param.label}:</span>
                <span class="text-slate-800">${profileStatus}</span>
                <span class="font-medium text-slate-700">Data:</span>
                <span class="text-slate-800">${dataFieldValue}</span>
            `;
            viewProfileParamsContainer.appendChild(div);
        });

        // Populate summary
        document.getElementById('viewBasicScore').textContent = `${audit.totalBasicScore} / 80`;
        document.getElementById('viewProfileScore').textContent = `${audit.totalProfileScore} / 20`;
        document.getElementById('viewTotalScore').textContent = `${audit.overallScore} / 100`;
        document.getElementById('viewAutomatedVerdict').textContent = audit.automatedVerdict;
        document.getElementById('viewAdditionalVerdict').textContent = audit.additionalVerdict || 'No additional feedback.';

        auditViewModal.classList.remove('hidden');
    };

    closeAuditViewModalBtn.addEventListener('click', () => {
        auditViewModal.classList.add('hidden');
    });

    // --- Master Data Management ---
    const populateDatalists = () => {
        const populateDatalist = (datalistEl, dataArray) => {
            datalistEl.innerHTML = '';
            dataArray.sort().forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                datalistEl.appendChild(option);
            });
        };
        populateDatalist(rmListDatalist, masterData.rms.map(rm => rm.name)); // For scorecard RM
        populateDatalist(teamListDatalist, masterData.teams);
        populateDatalist(captainListDatalist, masterData.captains);

        // For Manage Data tab RM section
        populateDatalist(teamListDatalistMgmt, masterData.teams);
        populateDatalist(captainListDatalistMgmt, masterData.captains);
    };

    const renderMasterDataLists = () => {
        // Render RMs table
        rmListDisplay.innerHTML = ''; // rmListDisplay is tbody
        masterData.rms.sort((a, b) => a.name.localeCompare(b.name)).forEach(rm => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-slate-900">${rm.name}</td>
                <td class="px-3 py-2 whitespace-nowrap text-sm text-slate-500">${rm.team || 'N/A'}</td>
                <td class="px-3 py-2 whitespace-nowrap text-sm text-slate-500">${rm.captain || 'N/A'}</td>
                <td class="px-3 py-2 whitespace-nowrap text-left text-sm font-medium">
                    <button data-value="${rm.name}" data-key="rms" class="remove-btn text-red-500 hover:text-red-700 text-xs px-2 py-1 rounded">Remove</button>
                </td>
            `;
            rmListDisplay.appendChild(row);
        });

        // Render Teams table
        teamListDisplay.innerHTML = ''; // teamListDisplay is tbody
        masterData.teams.sort().forEach(team => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-slate-900">${team}</td>
                <td class="px-3 py-2 whitespace-nowrap text-left text-sm font-medium">
                    <button data-value="${team}" data-key="teams" class="remove-btn text-red-500 hover:text-red-700 text-xs px-2 py-1 rounded">Remove</button>
                </td>
            `;
            teamListDisplay.appendChild(row);
        });

        // Render Captains table
        captainListDisplay.innerHTML = ''; // captainListDisplay is tbody
        masterData.captains.sort().forEach(captain => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-slate-900">${captain}</td>
                <td class="px-3 py-2 whitespace-nowrap text-left text-sm font-medium">
                    <button data-value="${captain}" data-key="captains" class="remove-btn text-red-500 hover:text-red-700 text-xs px-2 py-1 rounded">Remove</button>
                </td>
            `;
            captainListDisplay.appendChild(row);
        });
    };

    // Modified addMasterDataItem to handle RM objects and auto-add teams/captains
    const addMasterDataItem = (inputEl, dataArray, key, extraInput1 = null, extraInput2 = null) => {
        const value = inputEl.value.trim();
        if (!value) return;

        if (key === 'rms') {
            const teamValue = extraInput1 ? extraInput1.value.trim() : '';
            const captainValue = extraInput2 ? extraInput2.value.trim() : '';

            // --- MANDATORY CHECK FOR TEAM AND CAPTAIN FOR RM ---
            if (!teamValue) {
                alert('Team Name is required for Relationship Manager.');
                return;
            }
            if (!captainValue) {
                alert('Captain Name is required for Relationship Manager.');
                return;
            }

            if (masterData.rms.some(rm => rm.name === value)) {
                alert('Relationship Manager with this name already exists.');
                return;
            }

            const newRm = { id: Date.now(), name: value, team: teamValue, captain: captainValue };
            masterData.rms.push(newRm);

            // Auto-add new team/captain if they don't exist in their respective lists
            if (!masterData.teams.includes(teamValue)) {
                masterData.teams.push(teamValue);
                masterData.teams.sort();
            }
            if (!masterData.captains.includes(captainValue)) {
                masterData.captains.push(captainValue);
                masterData.captains.sort();
            }

            inputEl.value = '';
            if (extraInput1) extraInput1.value = '';
            if (extraInput2) extraInput2.value = '';

        } else { // For teams and captains (simple string arrays)
            if (!dataArray.includes(value)) {
                dataArray.push(value);
                dataArray.sort();
                inputEl.value = '';
            } else {
                alert(`${key.slice(0, -1)} with this name already exists.`);
                inputEl.value = '';
                return;
            }
        }
        saveMasterData();
        renderMasterDataLists();
        populateDatalists();
        updateFilters();
    };


    const removeMasterDataItem = (value, dataArray, key) => {
        if (key === 'rms') {
            const index = dataArray.findIndex(rm => rm.name === value);
            if (index > -1) {
                dataArray.splice(index, 1);
            }
        } else {
            const index = dataArray.indexOf(value);
            if (index > -1) {
                dataArray.splice(index, 1);
            }
        }
        saveMasterData();
        renderMasterDataLists();
        populateDatalists();
        updateFilters();
    };

    addRmButton.addEventListener('click', () => addMasterDataItem(newRmNameInput, masterData.rms, 'rms', newRmTeamInput, newRmCaptainInput));
    addTeamButton.addEventListener('click', () => addMasterDataItem(newTeamNameInput, masterData.teams, 'teams'));
    addCaptainButton.addEventListener('click', () => addMasterDataItem(newCaptainNameInput, masterData.captains, 'captains'));

    // Delegated event listener for remove buttons on the new tables in Manage Data tab
    document.getElementById('manage-tab').addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-btn')) {
            const value = e.target.dataset.value;
            const key = e.target.dataset.key;
            if (key === 'rms') removeMasterDataItem(value, masterData.rms, 'rms');
            else if (key === 'teams') removeMasterDataItem(value, masterData.teams, 'teams');
            else if (key === 'captains') removeMasterDataItem(value, masterData.captains, 'captains');
        }
    });

    // --- LLM Integration ---

    // Feature 1: Summarize Feedback
    summarizeFeedbackBtn.addEventListener('click', async () => {
        const feedbackText = additionalVerdict.value.trim();
        if (!feedbackText) {
            alert('Please enter some feedback to summarize.');
            return;
        }

        summarizeLoading.classList.remove('hidden');
        summarizeFeedbackBtn.disabled = true;

        try {
            const prompt = `Summarize the following customer support call feedback concisely in a few bullet points:\n\n${feedbackText}`;
            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();

            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                const summarizedText = result.candidates[0].content.parts[0].text;
                additionalVerdict.value = summarizedText;
            } else {
                console.error("Gemini API response structure unexpected:", result);
                alert("Failed to summarize feedback. Please try again.");
            }
        } catch (error) {
            console.error("Error calling Gemini API for summarization:", error);
            alert("An error occurred while summarizing feedback.");
        } finally {
            summarizeLoading.classList.add('hidden');
            summarizeFeedbackBtn.disabled = false;
        }
    });

    // Feature 2: Generate Coaching Tips
    generateCoachingTipsBtn.addEventListener('click', async () => {
        coachingTipsDisplay.innerHTML = '';
        coachingTipsLoading.classList.remove('hidden');
        generateCoachingTipsBtn.disabled = true;

        const rmFilter = document.getElementById('filterRM').value;
        const teamFilter = document.getElementById('filterTeam').value;
        const weekFilter = document.getElementById('filterWeek').value;

        let filteredCoachingData = auditData;
        if (teamFilter !== 'all') filteredCoachingData = filteredCoachingData.filter(d => d.teamName === teamFilter);
        if (rmFilter !== 'all') filteredCoachingData = filteredCoachingData.filter(d => d.rmName === rmFilter);
        if (weekFilter !== 'all') filteredCoachingData = filteredCoachingData.filter(d => d.weekNumber == weekFilter);

        if (filteredCoachingData.length === 0) {
            coachingTipsDisplay.innerHTML = '<p class="text-red-500">No audit data available for the selected filters to generate coaching tips.</p>';
            coachingTipsLoading.classList.add('hidden');
            generateCoachingTipsBtn.disabled = false;
            return;
        }

        let performanceSummary = `Generate 3-5 concise, actionable coaching tips for the Relationship Manager(s) based on the following audit data. Focus on areas for improvement and maintain a supportive tone.
        `;
        
        if (rmFilter !== 'all') {
            performanceSummary = `Generate 3-5 concise, actionable coaching tips specifically for Relationship Manager "${rmFilter}" based on their audit data. Focus on areas for improvement and maintain a supportive tone.
            `;
        }

        let allFailurePoints = {};
        let totalAuditsConsidered = filteredCoachingData.length;
        let averageScore = filteredCoachingData.reduce((sum, d) => sum + d.overallScore, 0) / totalAuditsConsidered;

        performanceSummary += `Overall Average Score: ${averageScore.toFixed(2)}/100 across ${totalAuditsConsidered} audit(s).\n\n`;

        auditParams.basic.forEach(cat => {
            cat.items.forEach(param => {
                const paramLabel = param.label;
                let failureCount = 0;
                filteredCoachingData.forEach(audit => {
                    if (param.type === 'checkbox') {
                        if (audit.scores[param.id] === false) failureCount++;
                    } else if (param.type === 'discussion-checkbox') {
                        const discussionStatus = audit.scores[`discussion-${param.id}`];
                        if (discussionStatus === 'Discussed' && audit.scores[param.id] === false) {
                            failureCount++;
                        }
                    } else {
                        if (audit.scores[param.id] !== undefined && audit.scores[param.id] < (param.weight * 0.6)) {
                            failureCount++;
                        }
                    }
                });
                if (failureCount > 0) {
                    allFailurePoints[paramLabel] = (allFailurePoints[paramLabel] || 0) + failureCount;
                }
            });
        });

        auditParams.profile.forEach(param => {
            const paramLabel = param.label;
            let failureCount = 0;
            filteredCoachingData.forEach(audit => {
                if (audit.scores[param.id] === 'No' || audit.scores[param.id] === 'N/A') {
                    failureCount++;
                }
            });
            if (failureCount > 0) {
                allFailurePoints[paramLabel] = (allFailurePoints[paramLabel] || 0) + failureCount;
            }
        });

        const sortedFailurePoints = Object.entries(allFailurePoints).sort(([,a],[,b]) => b-a);
        
        if (sortedFailurePoints.length > 0) {
            performanceSummary += "Identified areas for improvement (frequency in filtered audits):\n";
            sortedFailurePoints.slice(0, 5).forEach(([label, count]) => {
                performanceSummary += `- ${label}: ${count} instance(s) of sub-optimal performance.\n`;
            });
        } else {
            performanceSummary += "No specific areas of frequent sub-optimal performance identified in the filtered data. Focus on continuous improvement and maintaining high standards.\n";
        }

        const verdicts = filteredCoachingData.map(d => d.automatedVerdict + (d.additionalVerdict ? ` (Additional: ${d.additionalVerdict})` : '')).filter(Boolean);
        if (verdicts.length > 0) {
            performanceSummary += "\nAggregated Verdicts:\n" + verdicts.join("\n");
        }

        try {
            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: performanceSummary }] });
            const payload = { contents: chatHistory };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();

            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                const tipsText = result.candidates[0].content.parts[0].text;
                coachingTipsDisplay.innerHTML = tipsText.replace(/\n/g, '<br>');
            } else {
                console.error("Gemini API response structure unexpected:", result);
                coachingTipsDisplay.innerHTML = '<p class="text-red-500">Failed to generate coaching tips. Please try again.</p>';
            }
        } catch (error) {
            console.error("Error calling Gemini API for coaching tips:", error);
            coachingTipsDisplay.innerHTML = '<p class="text-red-500">An error occurred while generating coaching tips.</p>';
        } finally {
            coachingTipsLoading.classList.add('hidden');
            generateCoachingTipsBtn.disabled = false;
        }
    });

    closeCoachingModalBtn.addEventListener('click', () => {
        coachingModal.classList.add('hidden');
    });

    // Feature: Generate Feedback for individual parameters
    basicParamsContainer.addEventListener('click', async (e) => {
        if (e.target.classList.contains('generate-feedback-btn')) {
            const paramId = e.target.dataset.paramId;
            const scoreEl = document.getElementById(paramId);
            const feedbackEl = document.getElementById(`feedback-${paramId}`);
            const loadingEl = document.getElementById(`feedbackLoading-${paramId}`);
            const paramInfo = auditParams.basic.flatMap(cat => cat.items).find(item => item.id === paramId);

            if (!paramInfo || !scoreEl || !feedbackEl) return;

            let currentScore;
            let maxScore = paramInfo.weight;

            if (paramInfo.type === 'checkbox' || paramInfo.type === 'discussion-checkbox') {
                currentScore = scoreEl.checked ? maxScore : 0;
                const discussionEl = document.getElementById(`discussion-${paramId}`);
                if (discussionEl && discussionEl.value === 'Not Discussed') {
                    currentScore = maxScore; // If not discussed, points are awarded
                }
            } else {
                currentScore = parseInt(scoreEl.value, 10);
            }

            loadingEl.classList.remove('hidden');
            e.target.disabled = true;

            try {
                const prompt = `Generate a brief, constructive feedback point for an agent who scored ${currentScore} out of ${maxScore} for "${paramInfo.label}". If the score is perfect, suggest maintaining excellence and what was done well. If the score is low (e.g., 0-${Math.floor(maxScore*0.5)}), suggest specific areas for immediate improvement and how to achieve full points. If the score is mid-range, suggest how to elevate performance further.`;
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const generatedFeedback = result.candidates[0].content.parts[0].text;
                    feedbackEl.value = generatedFeedback.trim();
                    calculateScores(); // Recalculate to check save button status
                } else {
                    console.error("Gemini API response structure unexpected:", result);
                    feedbackEl.value = "Failed to generate feedback.";
                }
            } catch (error) {
                console.error("Error calling Gemini API for parameter feedback:", error);
                feedbackEl.value = "Error generating feedback.";
            } finally {
                loadingEl.classList.add('hidden');
                e.target.disabled = false;
            }
        }
    });


    closeValidationModalBtn.addEventListener('click', () => {
        validationModal.classList.add('hidden');
    });

    // --- Print Scorecard Function ---
    printScorecardBtn.addEventListener('click', async () => {
        const currentRmFilter = document.getElementById('filterRM').value;
        const currentTeamFilter = document.getElementById('filterTeam').value;
        const currentWeekFilter = document.getElementById('filterWeek').value;

        // Generate coaching tips first
        await generateCoachingTipsBtn.click();
        const coachingTipsHtml = coachingTipsDisplay.innerHTML;

        let filteredDataForPrint = auditData;
        if (currentTeamFilter !== 'all') filteredDataForPrint = filteredDataForPrint.filter(d => d.teamName === currentTeamFilter);
        if (currentRmFilter !== 'all') filteredDataForPrint = filteredDataForPrint.filter(d => d.rmName === currentRmFilter);
        if (currentWeekFilter !== 'all') filteredDataForPrint = filteredDataForPrint.filter(d => d.weekNumber == currentWeekFilter);

        // Sort by RM Name and then by Date for consistent printing
        filteredDataForPrint.sort((a, b) => {
            const rmCompare = a.rmName.localeCompare(b.rmName);
            if (rmCompare !== 0) return rmCompare;
            return new Date(a.auditDate) - new Date(b.auditDate);
        });

        let printContentHtml = `
            <div class="print-container">
                <h1 style="text-align: center; font-size: 1.875rem; font-weight: bold; margin-bottom: 1rem;">CenturyPly QA Scorecard Audit Report</h1>
                <h2 style="text-align: center; font-size: 1.25rem; font-weight: 500; color: #475569; margin-bottom: 2rem;">
                    ${currentRmFilter !== 'all' ? `Report for RM: <span style="font-weight: bold;">${currentRmFilter}</span>` : 'Overall Performance Report'}
                    ${currentTeamFilter !== 'all' ? ` (Team: <span style="font-weight: bold;">${currentTeamFilter}</span>)` : ''}
                    ${currentWeekFilter !== 'all' ? ` (Week: <span style="font-weight: bold;">${currentWeekFilter}</span>)` : ''}
                </h2>
        `;

        if (filteredDataForPrint.length === 0) {
            printContentHtml += `<p style="text-align: center; color: #ef4444;">No audit data available for the selected filters.</p>`;
        } else {
            // Include general summary if not RM-specific
            if (currentRmFilter === 'all' && filteredDataForPrint.length > 0) {
                const totalAudits = filteredDataForPrint.length;
                const averageOverallScore = filteredDataForPrint.reduce((sum, d) => sum + d.overallScore, 0) / totalAudits;
                printContentHtml += `
                    <fieldset style="margin-bottom: 1.5rem; border: 1px solid #e2e8f0; padding: 1rem; border-radius: 0.5rem;">
                        <legend style="font-size: 1.125rem; font-weight: 600; color: #475569; padding: 0 0.5rem;">Summary for Filtered Data</legend>
                        <p class="text-sm">Total Audits in Filter: <span class="font-medium">${totalAudits}</span></p>
                        <p class="text-sm">Average Overall Score: <span class="font-medium">${averageOverallScore.toFixed(2)} / 100</span></p>
                    </fieldset>
                `;
            }

            // Loop through each audit record to display detailed audit reports
            filteredDataForPrint.forEach(audit => {
                printContentHtml += `
                    <div class="print-audit-record" style="margin-bottom: 2rem; padding: 1.5rem; background-color: #fff; border-radius: 0.75rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);">
                        <h3 style="font-size: 1.25rem; font-weight: 600; color: #1e293b; margin-bottom: 1rem;">Audit Record - ${audit.auditDate} (${audit.rmName})</h3>
                        
                        <fieldset style="margin-bottom: 1rem; border: 1px solid #e2e8f0; padding: 1rem; border-radius: 0.5rem;">
                            <legend style="font-size: 1rem; font-weight: 600; color: #475569; padding: 0 0.5rem;">Audit Context</legend>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; font-size: 0.875rem;">
                                <div><span class="font-medium text-slate-600">RM Name:</span> <span class="text-slate-800">${audit.rmName}</span></div>
                                <div><span class="font-medium text-slate-600">Team Name:</span> <span class="text-slate-800">${audit.teamName}</span></div>
                                <div><span class="font-medium text-slate-600">Captain:</span> <span class="text-slate-800">${audit.captainName}</span></div>
                                <div><span class="font-medium text-slate-600">Audit Date:</span> <span class="text-slate-800">${audit.auditDate}</span></div>
                                <div><span class="font-medium text-slate-600">Week No.:</span> <span class="text-slate-800">${audit.weekNumber}</span></div>
                                <div><span class="font-medium text-slate-600">AID Mobile:</span> <span class="text-slate-800">${audit.aidMobile}</span></div>
                            </div>
                        </fieldset>

                        <fieldset style="margin-bottom: 1rem; border: 1px solid #e2e8f0; padding: 1rem; border-radius: 0.5rem;">
                            <legend style="font-size: 1rem; font-weight: 600; color: #475569; padding: 0 0.5rem;">Basic Call Audit</legend>
                            <div style="font-size: 0.875rem;">`;
                            auditParams.basic.forEach(cat => {
                                printContentHtml += `<h4 style="font-weight: 600; margin-top: 0.75rem; margin-bottom: 0.25rem; border-bottom: 1px dashed #e2e8f0; padding-bottom: 0.25rem; color: #334155;">${cat.category}</h4>`;
                                cat.items.forEach(param => {
                                    const paramValue = audit.scores[param.id];
                                    const feedbackValue = audit.scores[`feedback-${param.id}`] || 'N/A';
                                    let displayValue;
                                    if (param.type === 'checkbox' || param.type === 'discussion-checkbox') {
                                        displayValue = paramValue ? 'Achieved' : 'Not Achieved';
                                        if (param.type === 'discussion-checkbox') {
                                            const discussionStatus = audit.scores[`discussion-${param.id}`] || 'Discussed';
                                            displayValue = `${discussionStatus} - ${displayValue}`;
                                        }
                                    } else {
                                        displayValue = `${paramValue} / ${param.weight}`;
                                    }
                                    printContentHtml += `
                                        <p><span class="font-medium text-slate-700">${param.label}:</span> <span class="text-slate-800">${displayValue}</span></p>
                                        <p class="ml-4"><span class="font-medium text-slate-700">Feedback:</span> <span class="text-slate-800">${feedbackValue}</span></p>
                                    `;
                                });
                            });
                printContentHtml += `</div></fieldset>`;

                printContentHtml += `
                        <fieldset style="margin-bottom: 1rem; border: 1px solid #e2e8f0; padding: 1rem; border-radius: 0.5rem;">
                            <legend style="font-size: 1rem; font-weight: 600; color: #475569; padding: 0 0.5rem;">AID Profile Completeness</legend>
                            <div style="font-size: 0.875rem;">`;
                            auditParams.profile.forEach(param => {
                                const profileStatus = audit.scores[param.id] || 'N/A';
                                const dataFieldValue = audit.scores[`data-${param.id}`] || 'N/A';
                                printContentHtml += `
                                    <p><span class="font-medium text-slate-700">${param.label}:</span> <span class="text-slate-800">${profileStatus}</span></p>
                                    <p class="ml-4"><span class="font-medium text-slate-700">Data:</span> <span class="text-slate-800">${dataFieldValue}</span></p>
                                `;
                            });
                printContentHtml += `</div></fieldset>`;

                printContentHtml += `
                        <fieldset style="margin-bottom: 1.5rem; border: 1px solid #e2e8f0; padding: 1rem; border-radius: 0.5rem;">
                            <legend style="font-size: 1.125rem; font-weight: 600; color: #475569; padding: 0 0.5rem;">Audit Summary</legend>
                            <p class="text-sm"><span class="font-medium text-slate-600">Basic Score:</span> <span class="text-slate-800 font-bold">${audit.totalBasicScore} / 80</span></p>
                            <p class="text-sm"><span class="font-medium text-slate-600">Profile Score:</span> <span class="text-slate-800 font-bold">${audit.totalProfileScore} / 20</span></p>
                            <p style="font-size: 1.125rem; font-weight: bold; color: #2563eb; margin-top: 0.5rem;"><span class="font-medium">Overall Score:</span> ${audit.overallScore} / 100</p>
                            <p class="text-sm"><span class="font-medium text-slate-600">Automated Verdict:</span> <span class="text-slate-800">${audit.automatedVerdict}</span></p>
                            <p class="text-sm"><span class="font-medium text-slate-600">Additional Feedback:</span> <span class="text-slate-800">${audit.additionalVerdict || 'No additional feedback.'}</span></p>
                        </fieldset>
                    </div>
                `;
            });
        }
        
        // Add coaching tips to the print output
        printContentHtml += `
            <div class="print-coaching-tips" style="margin-top: 2rem; padding: 1.5rem; background-color: #f0f9ff; border-radius: 0.75rem; border: 1px solid #bfdbfe;">
                <h3 style="font-size: 1.5rem; font-weight: 600; color: #1e293b; margin-bottom: 1rem;">Performance Coaching Tips</h3>
                <div style="color: #334155; line-height: 1.5;">${coachingTipsHtml}</div>
            </div>
            </div>
        `;

        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>QA Scorecard Report</title>
                <link rel="preconnect" href="https://fonts.googleapis.com">
                <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
                <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
                <style>
                    body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; background-color: #fff; }
                    .print-container {
                        width: 210mm; /* A4 width */
                        min-height: 297mm; /* A4 height, helps with initial sizing but dynamic content will extend */
                        margin: 0 auto;
                        padding: 20mm;
                        box-sizing: border-box;
                    }
                    h1, h2, h3, h4, p { margin: 0; padding: 0; }
                    fieldset { border: 1px solid #e2e8f0; padding: 1rem; margin-bottom: 1rem; border-radius: 0.5rem; }
                    legend { font-weight: 600; color: #475569; padding: 0 0.5rem; }
                    .grid { display: grid; }
                    .text-sm { font-size: 0.875rem; }
                    .font-medium { font-weight: 500; }
                    .font-bold { font-weight: 700; }
                    .text-slate-600 { color: #475569; }
                    .text-slate-800 { color: #1e293b; }
                    .text-blue-600 { color: #2563eb; }
                    .ml-4 { margin-left: 1rem; }

                    /* Print specific page breaking and margins */
                    @media print {
                        .print-audit-record {
                            page-break-after: always;
                        }
                        .print-audit-record:last-of-type { 
                            page-break-after: auto; 
                        }
                        .print-coaching-tips {
                            page-break-before: always;
                            margin-top: 20mm; 
                        }
                        @page {
                            size: A4;
                            margin: 15mm; 
                        }
                        p, div { line-height: 1.3; margin-bottom: 0.3em; }
                        fieldset { margin-bottom: 0.8rem; padding: 0.8rem; }
                        h3 { margin-bottom: 0.8rem; }
                    }
                </style>
            </head>
            <body>
                ${printContentHtml}
            
<!-- Toast Container -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
  <div id="toastContainer"></div>
</div>

</body>
            </html>
        `);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
    });

    // Feature: LLM for Fishbone Causes
    generateFishboneCausesBtn.addEventListener('click', async () => {
        fishboneCausesDisplay.innerHTML = '';
        fishboneCausesLoading.classList.remove('hidden');
        generateFishboneCausesBtn.disabled = true;

        const prompt = `Generate a few brief, high-level conceptual ideas for root causes under each of the 6 M's (Man, Machine, Materials, Method, Measurement, Mother Nature/Environment) for a general "Quality Issue" in a sales/support call center context. Focus on actionable insights for brainstorming. Provide the output in a list format, grouped by category.`;
        
        try {
            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();

            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                const generatedCauses = result.candidates[0].content.parts[0].text;
                fishboneCausesDisplay.innerHTML = generatedCauses.replace(/\n/g, '<br>');
            } else {
                console.error("Gemini API response structure unexpected:", result);
                fishboneCausesDisplay.innerHTML = '<p class="text-red-500">Failed to generate cause ideas. Please try again.</p>';
            }
        } catch (error) {
            console.error("Error calling Gemini API for fishbone causes:", error);
            fishboneCausesDisplay.innerHTML = '<p class="text-red-500">An error occurred while generating cause ideas.</p>';
        } finally {
            fishboneCausesLoading.classList.add('hidden');
            generateFishboneCausesBtn.disabled = false;
        }
    });


    // Initial Load
    loadMasterData();
    loadAuditData();
    initCharts();
    updateDashboard();
    calculateScores(); // Initial call to set verdict and button state
    populateDatalists();
    calculateWeekNumber();
    setFormElementsEnabled(true); // Initial state: form enabled for new entry
});
</script>

<!-- Toast Container -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
  <div id="toastContainer"></div>
</div>

</body>
</html>
